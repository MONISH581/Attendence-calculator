<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Panel — Myshakthiview Digital Attendance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
    .dashboard-header {
      background: linear-gradient(90deg, #1e3a8a 0%, #1e40af 60%, #6366f1 100%);
    }
    .dashboard-title {
      color: #fff;
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: -1px;
    }
    .dashboard-institute {
      color: #cbd5e1;
      font-size: 1rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
<div id="teacher-app" class="min-h-screen">
  <div class="dashboard-header shadow-2xl">
    <div class="max-w-6xl mx-auto px-4 py-6 sm:py-8 flex flex-col sm:flex-row items-center justify-between">
      <div class="mb-6 sm:mb-0">
        <h1 class="dashboard-title">Myshakthiview — Digital Attendance</h1>
        <div class="dashboard-institute">Teacher Attendance Management Panel</div>
      </div>
      <div class="text-center sm:text-right bg-white/20 rounded-xl shadow-inner p-3">
        <div class="text-sm text-blue-100 font-medium">Today's Date:</div>
        <div class="text-lg font-semibold text-white" id="today"></div>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-8">
    <section class="bg-white rounded-xl shadow-lg p-6 mb-8 border-t-4 border-sky-700">
      <div class="flex flex-col md:flex-row md:items-center md:gap-6 gap-4 mb-5">

        <div class="flex flex-col gap-2 flex-1 min-w-[140px]">
          <label class="block text-sm font-medium text-gray-600">Choose Year</label>
          <select id="yearCohortSelect" class="border rounded px-3 py-2 bg-gray-50 font-medium focus:ring-sky-500">
            <option value="first">First Year (2025-2029)</option>
            <option value="second" selected>Second Year (2024-2028)</option>
            <option value="third">Third Year (2023-2027)</option>
            <option value="fourth">Fourth Year (2022-2026)</option>
          </select>
        </div>

        <div class="flex flex-col gap-2 flex-1 min-w-[120px]">
          <label class="block text-sm font-medium text-gray-600">Academic Session</label>
          <select id="sessionSelect" class="border rounded px-3 py-2 bg-gray-50 font-medium focus:ring-sky-500">
            <option selected>2025-2026</option>
            <option>2026-2027</option>
            <option>2027-2028</option>
            <option>2028-2029</option>
          </select>
        </div>

        <div class="flex flex-col gap-2 flex-1 min-w-[100px]">
          <label class="block text-sm font-medium text-gray-600">Semester</label>
          <select id="semTypeSelect" class="border rounded px-3 py-2 bg-gray-50 font-medium focus:ring-sky-500">
            <option>1 Semester</option>
            <option>2 Semester</option>
            <option>3 Semester</option>
            <option>4 Semester</option>
            <option>5 Semester</option>
            <option>6 Semester</option>
            <option>7 Semester</option>
            <option>8 Semester</option>
          </select>
        </div>

        <div class="flex flex-col gap-2 flex-1 min-w-[100px]">
          <label class="block text-sm font-medium text-gray-600">Department</label>
          <select id="deptFilter" class="border border-gray-300 rounded-xl px-4 py-2.5 transition-shadow focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
            <option value="">-- Select Department --</option>
            <option value="CSE">CSE</option>
            <option value="ECE">ECE</option>
            <option value="EEE">EEE</option>
            <option value="MECH">MECH</option>
          </select>
        </div>

        <div class="flex flex-col gap-2 flex-1 min-w-[100px]">
          <label class="block text-sm font-medium text-gray-600">Section</label>
          <select id="sectionFilter" class="border border-gray-300 rounded-xl px-4 py-2.5 transition-shadow focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
            <option value="">-- Select Section --</option>
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
            <option value="E">E</option>
          </select>
        </div>

        <div class="flex flex-col gap-2 flex-1 min-w-[100px]">
          <label class="block text-sm font-medium text-gray-600">Subject</label>
          <select id="subjectFilter" class="border border-gray-300 rounded-xl px-4 py-2.5 transition-shadow focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
            <option value="">-- Select Subject --</option>
            <option value="Maths">Maths</option>
          </select>
        </div>

      </div>
      <div class="flex flex-col sm:flex-row gap-4 mb-2">
        <div class="flex-1 min-w-48">
          <label class="block text-sm font-medium text-gray-600 mb-1">Search Name / Roll No</label>
          <input id="search" class="w-full border border-gray-300 rounded-xl px-4 py-2.5 transition-shadow focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="Search name or roll no"/>
        </div>
        <div class="min-w-32">
          <label class="block text-sm font-medium text-gray-600 mb-1">Class</label>
          <input id="classFilter" class="w-full border border-gray-300 rounded-xl px-4 py-2.5 transition-shadow focus:ring-2 focus:ring-sky-500 focus:border-sky-500" placeholder="e.g., CSE-A"/>
        </div>
        <button id="refreshBtn" class="w-full sm:w-auto px-6 py-2.5 rounded-xl bg-sky-600 text-white font-medium shadow-md hover:bg-sky-700 transition-all transform hover:scale-[1.01] active:scale-95 self-end">
          Refresh List
        </button>
      </div>
    </section>

    <section id="studentList" class="space-y-4"></section>
    <div id="messageBoxContainer"></div>
  </div>
</div>

<script>
function fmtDate(d=new Date()){return d.toISOString().slice(0,10);}
document.getElementById("today").textContent = fmtDate();

const listEl = document.getElementById("studentList");
const searchEl = document.getElementById("search");
const classEl = document.getElementById("classFilter");
const deptEl = document.getElementById("deptFilter");
const subjectEl = document.getElementById("subjectFilter");
const sectionEl = document.getElementById("sectionFilter");
const yearCohortEl = document.getElementById("yearCohortSelect");
const sessionEl = document.getElementById("sessionSelect");
const semEl = document.getElementById("semTypeSelect");
document.getElementById("refreshBtn").onclick = () => load();

// Auto-refresh list when filters change
;[searchEl, classEl, deptEl, sectionEl, yearCohortEl].forEach(el => {
  el.addEventListener('change', () => load());
  if (el.tagName === 'INPUT') el.addEventListener('input', () => load());
});

function displayTemporaryMessage(message, type = 'blue') {
  const container = document.getElementById('messageBoxContainer');
  const colorClasses = {
    'green': 'bg-green-100 border-green-400 text-green-700',
    'red': 'bg-red-100 border-red-400 text-red-700',
    'blue': 'bg-blue-100 border-blue-400 text-blue-700'
  };
  const msgEl = document.createElement('div');
  msgEl.className = `fixed bottom-4 right-4 z-50 p-4 rounded-xl shadow-lg border-l-4 ${colorClasses[type]} transition-opacity duration-300`;
  msgEl.textContent = message;
  container.appendChild(msgEl);
  setTimeout(() => {
    msgEl.classList.add('opacity-0');
    setTimeout(() => msgEl.remove(), 300);
  }, 3000);
}

function updateSubjectOptionsForCurrentFilters(){
  const dept = (deptEl.value || '').toUpperCase();
  const cohort = (yearCohortEl.value || 'second');
  const semNum = parseInt((semEl.value || '1').toString(), 10) || 1;

  // Subject catalog by cohort -> semester -> department
  const SUBJECTS = {
    first: {
      1: { CSE: ['HTML','JAVA','MATHS'] },
      2: { CSE: ['HTML','JAVA','MATHS'] }
    },
    second: {
      3: { CSE: ['ADSA','OOPS','MATHS','BIOLOGY','MPMC','DBMS'] },
      4: { CSE: ['ADSA','OOPS','MATHS','BIOLOGY','MPMC','DBMS'] }
    },
    third: {
      5: { CSE: ['DBMS','OOPS','ADSA'] },
      6: { CSE: ['DBMS','OOPS','ADSA'] }
    },
    fourth: {
      7: { CSE: ['PROJECT','ELECTIVE','MATHS'] },
      8: { CSE: ['PROJECT','ELECTIVE','MATHS'] }
    }
  };

  let subjects = [];
  const byCohort = SUBJECTS[cohort] || {};
  const bySem = byCohort[semNum] || {};
  if (dept === 'CSE') {
    subjects = bySem.CSE || byCohort[Object.keys(byCohort)[0]]?.CSE || ['MATHS'];
  } else if (dept) {
    subjects = ['Maths'];
  } else {
    subjects = ['Maths'];
  }
  const current = subjectEl.value;
  subjectEl.innerHTML = '<option value="">-- Select Subject --</option>' +
    subjects.map(sub => `<option value="${sub}">${sub}</option>`).join('');
  if (current && subjects.includes(current)) subjectEl.value = current;
}

// Ensure subject options update immediately when upstream filters change
deptEl.addEventListener('change', updateSubjectOptionsForCurrentFilters);
sectionEl.addEventListener('change', updateSubjectOptionsForCurrentFilters);
yearCohortEl.addEventListener('change', updateSubjectOptionsForCurrentFilters);
semEl.addEventListener('change', updateSubjectOptionsForCurrentFilters);
updateSubjectOptionsForCurrentFilters();

// Cohort -> Sessions/semester mapping
const COHORTS = {
  first: { start: 2025, end: 2029, startSem: 1 },
  second: { start: 2024, end: 2028, startSem: 3 },
  third: { start: 2023, end: 2027, startSem: 5 },
  fourth: { start: 2022, end: 2026, startSem: 7 }
};

function populateSessionsForCohort(key){
  const cfg = COHORTS[key] || COHORTS.first;
  semEl.value = `${cfg.startSem} Semester`;
}

yearCohortEl.addEventListener('change', () => {
  populateSessionsForCohort(yearCohortEl.value);
});
populateSessionsForCohort(yearCohortEl.value);

async function load(){
  try {
    const res = await fetch("http://localhost:5000/api/students");
    if (!res.ok) throw new Error("Failed to fetch student data.");
    let students = await res.json();

    const searchQuery = (searchEl.value || "").toLowerCase();
    const classQuery = (classEl.value || "").toLowerCase();
    const deptQuery = (deptEl.value || "").toLowerCase();
    const sectionQuery = (sectionEl.value || "").toLowerCase();
    const cohortKey = yearCohortEl.value;
    updateSubjectOptionsForCurrentFilters();

    function inferBatchStartYear(st){
      if (typeof st.batchStartYear === 'number') return st.batchStartYear;
      const rn = (st.rollNo || '').match(/(\d{2})/);
      if (rn && rn[1]) return 2000 + parseInt(rn[1], 10);
      return null;
    }

    students = students.filter(s => {
      const classStr = (s.className || "").toLowerCase();
      const [clsDept = "", clsSection = ""] = classStr.split("-");
      const matchesSearch = !searchQuery || s.name.toLowerCase().includes(searchQuery) || (s.rollNo || "").toLowerCase().includes(searchQuery);
      const matchesClass = !classQuery || classStr.includes(classQuery);
      const matchesDept = !deptQuery || clsDept === deptQuery;
      const matchesSection = !sectionQuery || clsSection === sectionQuery;
      const cohortCfg = COHORTS[cohortKey] || COHORTS.second;
      const by = inferBatchStartYear(s);
      const matchesCohort = by ? (by === cohortCfg.start) : (cohortKey === 'second');
      return matchesSearch && matchesClass && matchesDept && matchesSection && matchesCohort;
    });

    listEl.innerHTML = "";
    if (!students.length) {
      listEl.innerHTML = '<div class="text-gray-500 text-center p-6 bg-white rounded-xl shadow">No students matching criteria.</div>';
      return;
    }

    students.forEach(s => {
      const div = document.createElement("div");
      div.className = "bg-white rounded-xl shadow p-4 sm:p-5 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 border-l-4 border-sky-500 transition-shadow hover:shadow-lg";
      div.innerHTML = `
        <div class="min-w-0 flex-1">
          <div class="text-xl font-bold text-gray-800 truncate">${s.name}</div>
          <div class="text-sm text-gray-500 mt-0.5">
            <span class="font-medium text-gray-700">Roll No:</span> ${s.rollNo || "N/A"}
            <span class="mx-2 text-gray-300">|</span>
            <span class="font-medium text-gray-700">Class:</span> ${s.className || "N/A"}
          </div>
        </div>
        <div class="flex items-center gap-3 mt-3 sm:mt-0">
          <button data-act="Present" data-id="${s._id}" 
              class="px-4 py-2 rounded-xl bg-green-600 text-white font-medium shadow-md hover:bg-green-700 transition-all transform hover:scale-[1.02] active:scale-95 whitespace-nowrap">
              Present
          </button>
          <button data-act="Absent" data-id="${s._id}" 
              class="px-4 py-2 rounded-xl bg-red-600 text-white font-medium shadow-md hover:bg-red-700 transition-all transform hover:scale-[1.02] active:scale-95 whitespace-nowrap">
              Absent
          </button>
          <button data-view="${s._id}" 
              class="px-4 py-2 rounded-xl border border-gray-300 text-gray-700 bg-gray-50 hover:bg-gray-100 transition-all transform active:scale-95 whitespace-nowrap">
              View
          </button>
        </div>
      `;
      div.addEventListener("click", async (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;

        if (btn.dataset.view) {
          try {
            const r = await fetch(`http://localhost:5000/api/students/${btn.dataset.view}`);
            if (!r.ok) {
              const errData = await r.json().catch(() => ({}));
              displayTemporaryMessage(`Failed to load attendance: ${errData.message || r.statusText}`, "red");
              return;
            }
            const st = await r.json();
            displayViewDetails(st.name, (st.attendance || []).slice(-5));
          } catch {
            displayTemporaryMessage("Failed to load attendance.", "red");
          }
          return;
        }

        const { id, act } = btn.dataset;
        const subjectSelected = subjectEl.value || null;
        btn.disabled = true;
        btn.classList.add("opacity-50", "cursor-not-allowed");
        try {
          const res = await fetch("http://localhost:5000/api/attendance/mark", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ studentId: id, status: act, date: fmtDate(), subject: subjectSelected }),
          });
          if (res.ok) {
            displayTemporaryMessage(`Attendance marked as "${act}" for ${s.name}.`, "green");
          } else {
            throw new Error("Failed to mark attendance.");
          }
        } catch (error) {
          displayTemporaryMessage(error.message || "Error marking attendance.", "red");
        } finally {
          btn.disabled = false;
          btn.classList.remove("opacity-50", "cursor-not-allowed");
        }
      });
      listEl.appendChild(div);
    });
  } catch (error) {
    displayTemporaryMessage("Error loading students.", "red");
  }
}
load();

function displayViewDetails(studentName, attendanceRecords) {
  const container = document.getElementById("messageBoxContainer");
  let content = '<div class="text-gray-500 text-sm">No recent records found.</div>';
  if (attendanceRecords.length > 0) {
    content = attendanceRecords.map(a => {
      const statusClass = a.status === 'Present' ? 'text-green-600' : 'text-red-600';
      return `
        <div class="flex justify-between py-2 border-b border-gray-100 last:border-b-0">
          <span class="font-medium text-gray-700">${a.date || ''}</span>
          <span class="font-semibold ${statusClass}">${a.status}</span>
        </div>
      `;
    }).join("");
  }
  container.innerHTML = `
    <div id="details-overlay" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 backdrop-blur-sm">
      <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg transform scale-100 transition-all duration-300">
        <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">Recent Attendance for <span class="text-blue-600">${studentName}</span></h3>
        <div class="max-h-60 overflow-y-auto space-y-1 pr-2">
          ${content}
        </div>
        <button 
          onclick="document.getElementById('details-overlay').remove()" 
          class="mt-6 w-full px-4 py-3 rounded-xl bg-sky-600 text-white font-medium shadow-md hover:bg-sky-700 transition-all active:scale-95"
        >
          Close
        </button>
      </div>
    </div>
  `;
}
</script>
</body>
</html>
